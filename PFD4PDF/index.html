<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Leitura da Ficha Cadastral</title>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --primary: #3b82f6;
      --success: #22c55e;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 40px;
      font-family: Inter, Arial, sans-serif;
      background: linear-gradient(120deg, #020617, #020617);
      color: var(--text);
    }

    h2 {
      margin-bottom: 20px;
      color: #f8fafc;
    }

    input[type="file"] {
      background: var(--card);
      border: 1px solid var(--border);
      padding: 10px;
      border-radius: 8px;
      color: var(--muted);
    }

    button {
      margin-top: 15px;
      padding: 12px 24px;
      border-radius: 10px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary), #2563eb);
      color: white;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.25);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(59, 130, 246, 0.35);
    }

    .resultado {
      margin-top: 35px;
      padding: 25px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      max-width: 900px;
    }

    .resultado h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #f1f5f9;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 14px;
    }

    .campo {
      padding: 12px 14px;
      background: #020617;
      border: 1px solid var(--border);
      border-radius: 10px;
    }

    .campo span {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .campo strong {
      font-size: 15px;
      color: var(--text);
    }

    .secao {
      margin-top: 30px;
    }

    .secao h4 {
      margin-bottom: 12px;
      color: var(--primary);
    }

    details {
      margin-top: 25px;
      background: #020617;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 14px;
    }

    details summary {
      cursor: pointer;
      color: var(--muted);
      font-weight: 600;
    }

    pre {
      margin-top: 10px;
      font-size: 12px;
      white-space: pre-wrap;
      color: #94a3b8;
    }

    /* Container de Upload */
    .upload-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      background: var(--card);
      padding: 30px;
      border-radius: 16px;
      border: 1px solid var(--border);
      margin-bottom: 30px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .input-group label {
      font-size: 14px;
      font-weight: 600;
      color: var(--primary);
    }

    /* Estiliza√ß√£o do Input de Arquivo */
    input[type="file"] {
      width: 100%;
      padding: 12px;
      background: #020617;
      border: 2px dashed var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: border-color 0.3s;
    }

    input[type="file"]:hover {
      border-color: var(--primary);
    }

    .button-group {
      grid-column: span 2;
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      margin-top: 10px;
    }

    @media (max-width: 600px) {
      .upload-container {
        grid-template-columns: 1fr;
      }

      .button-group {
        grid-column: span 1;
        flex-direction: column;
      }
    }
  </style>
</head>

<body>

  <h2>üìÑ Gestor de Contratos</h2>

  <div class="upload-container">
    <div class="input-group">
      <label for="pdfFicha">üìá Ficha do Cliente (PDF)</label>
      <input type="file" id="pdfFicha" accept="application/pdf">
    </div>

    <div class="input-group">
      <label for="contratoPadrao">üìú Contrato Padr√£o (PDF)</label>
      <input type="file" id="contratoPadrao" accept="application/pdf">
    </div>

    <div class="button-group">
      <button onclick="lerFicha()" style="background: transparent; border: 1px solid var(--primary); box-shadow: none;">
        üîç Analisar Ficha
      </button>
      <button onclick="gerarContrato()">
        üöÄ Gerar Novo Contrato
      </button>
    </div>
  </div>

  <div class="secao"
    style="margin-top: 20px; background: var(--card); padding: 20px; border-radius: 8px; border: 1px solid var(--border);">
    <h4>Dados Complementares (Manual)</h4>
    <div class="grid">
      <div class="campo">
        <span>Telefone Celular</span>
        <input type="text" id="manual-telefone" placeholder="(00) 00000-0000"
          style="width: 100%; background: #0f172a; border: 1px solid #334155; color: white; padding: 5px;">
      </div>
      <div class="campo">
        <span>MASP</span>
        <input type="text" id="manual-masp"
          style="width: 100%; background: #0f172a; border: 1px solid #334155; color: white; padding: 5px;">
      </div>
      <div class="campo">
        <span>Secretaria/Conv√™nio</span>
        <input type="text" id="manual-secretaria"
          style="width: 100%; background: #0f172a; border: 1px solid #334155; color: white; padding: 5px;">
      </div>
      <div class="campo">
        <span>Situa√ß√£o Funcional</span>
        <input type="text" id="manual-situacao"
          style="width: 100%; background: #0f172a; border: 1px solid #334155; color: white; padding: 5px;">
      </div>
      <div class="campo">
        <span>Cargo</span>
        <input type="text" id="manual-cargo" placeholder="Digite o cargo"
          style="width: 100%; background: #0f172a; border: 1px solid #334155; color: white; padding: 5px;">
      </div>
      <div class="campo">
        <span>Profiss√£o</span>
        <input type="text" id="manual-profissao" placeholder="Digite a profiss√£o"
          style="width: 100%; background: #0f172a; border: 1px solid #334155; color: white; padding: 5px;">
      </div>
    </div>


    <div id="saida" class="resultado" style="display:none;"></div>

    <script>
      let dadosParaContrato = null; // Vari√°vel global para armazenar os dados

      async function extrairTextoPrimeiraPagina(file) {
        const buffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
        const page = await pdf.getPage(1);
        const content = await page.getTextContent();
        return content.items.map(i => i.str).join(" ");
      }

      function extrairDados(texto) {
        const limpar = v => v ? v.replace(/\s+/g, " ").trim() : "";

        // üîπ Tipo de documento (bloco ap√≥s Sexo)
        const blocoDocumento = limpar(
          texto.match(/Sexo\s+[MF]\s+([\s\S]*?)\s+C√¥njuge/)?.[1]
        );

        // Normaliza√ß√£o
        let documento = blocoDocumento;
        if (/CARTEIRA/i.test(blocoDocumento)) {
          documento = "CARTEIRA NACIONAL DE HABILITA√á√ÉO";
        } else if (/IDENTIDADE/i.test(blocoDocumento)) {
          documento = "IDENTIDADE";
        }

        return {
          nome: limpar(
            texto.match(/Nome completo\s+(.*?)\s+CPF/)?.[1]
          ),

          cpf: limpar(
            texto.match(/CPF\s+([\d.\-]+)/)?.[1]
          ),

          // ‚úÖ ESTADO CIVIL REAL
          estadoCivil: limpar(
            texto.match(/Documento\s+(SOLTEIRO\(A\)|CASADO\(A\)|DIVORCIADO\(A\)|VI√öVO\(A\))/)?.[1]
          ),

          // ‚úÖ TIPO DO DOCUMENTO
          documento,

          numeroDocumento: limpar(
            texto.match(/N√∫mero\s+(\d{5,})/)?.[1]
          ),

          naturalidade: limpar(
            texto.match(/Naturalidade.*?\s+([A-Z√Ä-√ö\s]+)\s+Nascimento/)?.[1]
          ),

          nascimento: limpar(
            texto.match(/Nascimento\s+.*?(\d{2}\/\d{2}\/\d{4})/)?.[1]
          ),

          sexo: limpar(
            texto.match(/Sexo\s+([MF])/)?.[1]
          ),

          profissao: limpar(
            texto.match(/Profiss√£o\s+(.*?)\s+PC/)?.[1]
          ),

          numero: limpar(
            texto.match(/RUA\s+.*?\s(\d{1,5})\s+/)?.[1]
          ),

          cep: limpar(
            texto.match(/\b(\d{8})\b/)?.[1]
          )
        };
      }

      async function consultarCEP(cep) {
        const r = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const d = await r.json();
        if (d.erro) return null;
        return {
          logradouro: d.logradouro,
          bairro: d.bairro,
          municipio: d.localidade,
          uf: d.uf
        };
      }

      async function lerFicha() {
        const file = document.getElementById("pdfFicha").files[0];
        if (!file) return alert("Selecione um PDF");

        const texto = await extrairTextoPrimeiraPagina(file);
        const dados = extrairDados(texto);
        const endereco = dados.cep ? await consultarCEP(dados.cep) : null;

        // 2. SALVAR NA GLOBAL: Unificamos os dados extra√≠dos com os dados do CEP
        // Isso garante que a fun√ß√£o gerarContrato() tenha acesso a tudo
        dadosParaContrato = {
          ...dados,
          logradouro: endereco?.logradouro || "",
          bairro: endereco?.bairro || "",
          municipio: endereco?.municipio || "",
          uf: endereco?.uf || ""
        };

        const saida = document.getElementById("saida");
        saida.style.display = "block";

        // 3. Renderiza√ß√£o na tela (Interface do Usu√°rio)
        saida.innerHTML = `
        <h3>Dados extra√≠dos</h3>

        <div class="grid">
          <div class="campo"><span>Nome completo</span><strong>${dados.nome}</strong></div>
          <div class="campo"><span>CPF</span><strong>${dados.cpf}</strong></div>
          <div class="campo"><span>Documento</span><strong>${dados.documento}</strong></div>
          <div class="campo"><span>N¬∫ Documento</span><strong>${dados.numeroDocumento}</strong></div>
          <div class="campo"><span>Naturalidade</span><strong>${dados.naturalidade}</strong></div>
          <div class="campo"><span>Nascimento</span><strong>${dados.nascimento}</strong></div>
          <div class="campo"><span>Sexo</span><strong>${dados.sexo}</strong></div>
          <div class="campo"><span>Profiss√£o</span><strong>${dados.profissao}</strong></div>
          <div class="campo"><span>Estado civil</span><strong>${dados.estadoCivil}</strong></div>
        </div>

        <div class="secao">
          <h4>Endere√ßo residencial</h4>
          <div class="grid">
            <div class="campo"><span>Logradouro</span><strong>${endereco?.logradouro || '---'}</strong></div>
            <div class="campo"><span>N√∫mero</span><strong>${dados.numero}</strong></div>
            <div class="campo"><span>Bairro</span><strong>${endereco?.bairro || '---'}</strong></div>
            <div class="campo"><span>Munic√≠pio</span><strong>${endereco?.municipio || '---'}</strong></div>
            <div class="campo"><span>UF</span><strong>${endereco?.uf || '---'}</strong></div>
            <div class="campo"><span>CEP</span><strong>${dados.cep}</strong></div>
          </div>
        </div>

        <div style="margin-top: 20px;">
          <button onclick="gerarContrato()" style="background-color: #22c55e; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
            üìÑ Preencher e Baixar Contrato
          </button>
        </div>

        <details style="margin-top: 20px;">
          <summary>üîç Ver texto bruto (debug)</summary>
          <pre style="white-space: pre-wrap; background: #1e293b; padding: 10px; border-radius: 4px;">${texto}</pre>
        </details>
      `;
      }

      async function gerarContrato() {
        // Agora verificamos a vari√°vel global que criamos
        if (!dadosParaContrato) {
          alert("Por favor, carregue a ficha cadastral primeiro para extrair os dados.");
          return;
        }

        const { PDFDocument } = PDFLib;

        // Captura os valores dos campos manuais
        const telManual = document.getElementById('manual-telefone').value;
        const maspManual = document.getElementById('manual-masp').value;
        const secManual = document.getElementById('manual-secretaria').value;
        const sitManual = document.getElementById('manual-situacao').value;
        const cargoManual = document.getElementById('manual-cargo').value;
        const admissaoManual = document.getElementById('manual-admissao').value;

        try {
          // Carrega o arquivo contrato.pdf (certifique-se que ele est√° na mesma pasta)
          const response = await fetch('./contrato.pdf');
          if (!response.ok) throw new Error("Arquivo contrato.pdf n√£o encontrado na pasta.");
          const modeloBytes = await response.arrayBuffer();

          const pdfDoc = await PDFDocument.load(modeloBytes);
          const form = pdfDoc.getForm();

          // Fun√ß√£o auxiliar para preencher sem dar erro se o campo n√£o existir no PDF
          const preencher = (nomeCampo, valor) => {
            try {
              const campo = form.getTextField(nomeCampo);
              campo.setText(valor || '');
            } catch (e) {
              console.warn(`Aviso: Campo [${nomeCampo}] n√£o encontrado no PDF.`);
            }
          };

          // Preenchimento usando os nomes AcroForms que voc√™ mapeou
          preencher('Nome do Cooperadoa', dadosParaContrato.nome);
          preencher('CPF', dadosParaContrato.cpf);
          preencher('Estado Civil', dadosParaContrato.estadoCivil);
          preencher('Bairro', dadosParaContrato.bairro);
          preencher('Estado Civil_coop', dadosParaContrato.estadoCivil); //esta colocando em mais de um acroform
          //preencher('Nacionalidade', dadosParaContrato.naturalidade);
          preencher('Data de Nascimento', dadosParaContrato.nascimento);
          preencher('Profiss√£o', dadosParaContrato.profissao);
          preencher('N', dadosParaContrato.numero); // Se for o cel da ficha
          preencher('CEP', dadosParaContrato.cep);

          // NOVOS: Dados Manuais (Pegos dos inputs que criamos)
          preencher('Telefone Celular_coop', telManual);
          preencher('MASP', maspManual);
          preencher('Secretaria/Conv√™nio_coop', secManual);
          preencher('Situa√ß√£o Funcional', sitManual);
          preencher('cargo', cargoManual);
          preencher('Profiss√£o', profissaoManual);
          // Salva e baixa
          const pdfBytes = await pdfDoc.save();
          const blob = new Blob([pdfBytes], { type: 'application/pdf' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `Contrato_${dadosParaContrato.nome}.pdf`;
          link.click();

        } catch (error) {
          console.error(error);
          alert("Erro ao processar: " + error.message);
        }
      }
    </script>

</body>

</html>